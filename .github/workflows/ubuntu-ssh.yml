name: ğŸ§ UBUNTU SSH SERVER

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '6h'
        type: choice
        options:
        - '1h'
        - '2h'
        - '3h'
        - '4h'
        - '5h'
        - '6h'
      config:
        description: 'âš™ï¸ Cáº¥u hÃ¬nh VPS'
        required: false
        default: 'basic'
        type: choice
        options:
        - 'basic'
        - 'standard'
        - 'premium'

jobs:
  Ubuntu-SSH-Setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG UBUNTU
        run: |
          echo "ğŸ§ UBUNTU SSH SERVER"
          echo "âš¡ Powered by AI STV"
          echo "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}"
          echo "âš™ï¸ Cáº¥u hÃ¬nh: ${{ github.event.inputs.config }}"
          echo "âœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!"

      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          echo "ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG"
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server curl
          
          # Enable password authentication
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
          
          sudo systemctl restart ssh
          sudo systemctl enable ssh
          echo "âœ… SSH Server Ä‘Ã£ khá»Ÿi Ä‘á»™ng vá»›i Password Authentication"

      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N SSH
        run: |
          echo "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N"
          
          # Táº¡o password ngáº«u nhiÃªn
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9' | head -c 10)
          
          # Táº¡o user vá»›i password
          sudo useradd -m -s /bin/bash aistv-ubuntu
          echo "aistv-ubuntu:$PASSWORD" | sudo chpasswd
          
          # ThÃªm vÃ o sudo group
          sudo usermod -aG sudo aistv-ubuntu
          
          # Cho phÃ©p sudo khÃ´ng cáº§n password
          echo "aistv-ubuntu ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/aistv-ubuntu
          
          # Táº¡o welcome message
          sudo tee /home/aistv-ubuntu/.welcome_message << 'EOF'

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘        ğŸ‰ CHÃ€O Má»ªNG Äáº¾N Vá»šI VPS ANI STUDIO! ğŸ‰            â•‘
â•‘                                                            â•‘
â•‘  Báº¡n Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng vÃ o VPS Ubuntu cá»§a mÃ¬nh     â•‘
â•‘  Powered by AI STV - https://anishop.site                 â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF
          
          # ThÃªm vÃ o .bashrc Ä‘á»ƒ hiá»ƒn thá»‹ welcome message khi login
          echo '' | sudo tee -a /home/aistv-ubuntu/.bashrc
          echo '# Clear screen vÃ  hiá»ƒn thá»‹ welcome message' | sudo tee -a /home/aistv-ubuntu/.bashrc
          echo 'clear' | sudo tee -a /home/aistv-ubuntu/.bashrc
          echo 'cat ~/.welcome_message' | sudo tee -a /home/aistv-ubuntu/.bashrc
          echo '' | sudo tee -a /home/aistv-ubuntu/.bashrc
          
          sudo chown aistv-ubuntu:aistv-ubuntu /home/aistv-ubuntu/.welcome_message
          sudo chmod 644 /home/aistv-ubuntu/.welcome_message
          
          # LÆ°u thÃ´ng tin
          echo "SSH_USER=aistv-ubuntu" >> $GITHUB_ENV
          echo "SSH_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "$PASSWORD" > /tmp/ssh_password.txt
          
          echo "âœ… TÃ i khoáº£n: aistv-ubuntu Ä‘Ã£ sáºµn sÃ ng"

      - name: ğŸŒ THIáº¾T Láº¬P Máº NG TAILSCALE
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG"
          
          # CÃ i Ä‘áº·t Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Káº¿t ná»‘i Tailscale
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=ai-stv-ubuntu-$GITHUB_RUN_ID --accept-routes --accept-dns --reset
          
          # Láº¥y IP
          sleep 10
          TAILSCALE_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          
          echo "âœ… Äá»‹a chá»‰ IP: $TAILSCALE_IP"

      - name: ğŸ“¤ Gá»¬I THÃ”NG TIN Vá»€ WEBSITE
        run: |
          echo "ğŸ“¤ ÄANG Gá»¬I THÃ”NG TIN Vá»€ WEBSITE..."
          
          PASSWORD=$(cat /tmp/ssh_password.txt)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          # Gá»­i thÃ´ng tin vá» Supabase
          curl -X POST "https://wxqxriwodkgzpzqaxigp.supabase.co/functions/v1/update-rdp-info" \
            -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4cXhyaXdvZGtnenB6cWF4aWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Nzk0MDcsImV4cCI6MjA3OTQ1NTQwN30.u8piIXHELUvdN9klNTFhnBFrD0lzwMg0EMPcrz1Wfh8" \
            -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4cXhyaXdvZGtnenB6cWF4aWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Nzk0MDcsImV4cCI6MjA3OTQ1NTQwN30.u8piIXHELUvdN9klNTFhnBFrD0lzwMg0EMPcrz1Wfh8" \
            -H "Content-Type: application/json" \
            -d "{\"repoName\":\"$REPO_NAME\",\"ngrokUrl\":\"$TAILSCALE_IP\",\"rdpUser\":\"aistv-ubuntu\",\"rdpPassword\":\"$PASSWORD\",\"osType\":\"ubuntu\",\"sshPort\":22}" \
            || echo "âš ï¸ Lá»—i gá»­i thÃ´ng tin nhÆ°ng VPS váº«n hoáº¡t Ä‘á»™ng"
          
          echo "âœ… ÄÃ£ gá»­i thÃ´ng tin vá» website!"

      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          PASSWORD=$(cat /tmp/ssh_password.txt)
          
          # TÃ­nh thá»i gian
          DURATION="${{ github.event.inputs.duration }}"
          HOURS=${DURATION%h}
          
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚         ğŸ‰ UBUNTU SSH ÄÃƒ Sáº´N SÃ€NG!        â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ ğŸŒ  Äá»‹a chá»‰: $TAILSCALE_IP"
          echo "â”‚ ğŸ‘¤  User: aistv-ubuntu"
          echo "â”‚ ğŸ”  Password: $PASSWORD"
          echo "â”‚ â°  Thá»i lÆ°á»£ng: $HOURS giá»"
          echo "â”‚ ğŸ”Œ  SSH Port: 22"
          echo "â”‚ âš™ï¸  Config: ${{ github.event.inputs.config }}"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ ğŸ’¡  Káº¿t ná»‘i SSH:                          â”‚"
          echo "â”‚   ssh aistv-ubuntu@$TAILSCALE_IP          â”‚"
          echo "â”‚   (Nháº­p password khi Ä‘Æ°á»£c há»i)            â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          PASSWORD=$(cat /tmp/ssh_password.txt)
          DURATION="${{ github.event.inputs.duration }}"
          HOURS=${DURATION%h}
          MINUTES=$((HOURS * 60))
          
          echo "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..."
          echo "ğŸ’ Ubuntu SSH Server"
          echo "ğŸ”— Káº¿t ná»‘i: ssh aistv-ubuntu@$TAILSCALE_IP"
          echo "ğŸ• Thá»i gian: $HOURS giá»"
          
          # Countdown
          for ((i=MINUTES; i>0; i--)); do
            HOURS_LEFT=$((i / 60))
            MINS_LEFT=$((i % 60))
            echo -ne "\râ±ï¸ CÃ²n láº¡i: ${HOURS_LEFT}h ${MINS_LEFT}m   "
            sleep 60
          done
          
          echo ""
          echo "ğŸ¯ ÄÃƒ Háº¾T THá»œI GIAN - Tá»° Äá»˜NG Dá»ªNG!"

      - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
        if: always()
        run: |
          echo "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P Há»† THá»NG..."
          rm -f /tmp/ssh_password.txt
          sudo tailscale down --accept-risk=all || true
          echo "ğŸ‰ Dá»n dáº¹p hoÃ n táº¥t!"
